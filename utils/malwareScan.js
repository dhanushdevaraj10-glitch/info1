// Malware Scanner - Detects suspicious file names patterns
function malwareScan(filename) {
  const maliciousPatterns = [
    /\.exe$/i,
    /\.bat$/i,
    /\.cmd$/i,
    /\.scr$/i,
    /\.vbs$/i,
    /\.js$/i,
    /\.jar$/i,
    /\.zip$/i,
    /\.(php|asp|jsp)$/i,
    /shell|payload|malware|trojan|virus|worm|backdoor/i,
    /\.\.\/|\.\.\\|%2e%2e/i, // Directory traversal
    /[<>"|?*]/i // Special characters
  ];

  let detectionResults = {
    filename: filename,
    timestamp: new Date().toISOString(),
    isSuspicious: false,
    suspiciousPatterns: [],
    threatLevel: 'SAFE',
    recommendations: []
  };

  // Check against malicious patterns
  maliciousPatterns.forEach((pattern, index) => {
    if (pattern.test(filename)) {
      detectionResults.isSuspicious = true;
      detectionResults.suspiciousPatterns.push(pattern.source);
      
      // Set threat level
      if (index < 6) {
        detectionResults.threatLevel = 'HIGH';
        detectionResults.recommendations.push('Block executable file uploads');
      } else if (index < 10) {
        detectionResults.threatLevel = 'MEDIUM';
        detectionResults.recommendations.push('Review code-related files');
      }
    }
  });

  // Check filename length
  if (filename.length > 255) {
    detectionResults.isSuspicious = true;
    detectionResults.threatLevel = 'MEDIUM';
    detectionResults.suspiciousPatterns.push('Filename too long');
    detectionResults.recommendations.push('Rename file with shorter name');
  }

  // Check for hidden files
  if (filename.startsWith('.')) {
    detectionResults.threatLevel = 'LOW';
    detectionResults.recommendations.push('Verify purpose of hidden file');
  }

  return detectionResults;
}

module.exports = malwareScan;
